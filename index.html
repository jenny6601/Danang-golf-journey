<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>VIP å³´æ¸¯æœƒå®‰äº”æ—¥é«˜çˆ¾å¤«å¥¢è¯ä¹‹æ—…</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* Markers */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 40px; height: 40px; border-radius: 50% 50% 50% 0;
            position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -20px 0 0 -20px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
        }
        .marker-icon-svg {
            position: absolute; width: 22px; height: 22px; z-index: 10;
            transform: rotate(45deg); color: white; margin-top: 2px; margin-left: 2px;
        }

        /* Time Label & Arrow */
        .time-label-icon { background: transparent; border: none; }
        .arrow-on-line { filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }

        /* Colors */
        .bg-golf { background-color: #15803d; } /* Green-700 */
        .bg-hotel { background-color: #4338ca; } /* Indigo-700 */
        .bg-food { background-color: #c2410c; } /* Orange-700 */
        .bg-sight { background-color: #be185d; } /* Pink-700 */
        .bg-transport { background-color: #1d4ed8; } /* Blue-700 */

        /* Popup */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 260px !important; }
        
        /* Tooltip - Light Background Dark Text + Red Border */
        .custom-tooltip {
            background-color: rgba(255, 255, 255, 0.95); /* Light BG */
            color: #1e293b; /* Dark Text */
            border: 2px solid #ef4444; /* Red Border */
            border-radius: 6px;
            padding: 4px 8px; font-size: 13px; font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2);
            font-family: 'Noto Sans TC', sans-serif; margin-top: -2px;
            white-space: nowrap;
        }
        .leaflet-tooltip-bottom:before { border-bottom-color: #ef4444; }
        .leaflet-tooltip-top:before { border-top-color: #ef4444; }

        /* Layout */
        .mobile-view-active { display: flex !important; }
        .mobile-view-hidden { display: none !important; }
        @media (min-width: 1024px) {
            .mobile-view-hidden { display: flex !important; }
            .desktop-flex { display: flex !important; }
            #bottomNav { display: none !important; }
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        /* Image Zoom Cursor */
        .zoomable-image { cursor: zoom-in; transition: transform 0.2s; }
        .zoomable-image:hover { transform: scale(1.02); }

        /* Active Tab Style */
        .tab-btn.active {
            background-color: #f59e0b; /* Amber-500 */
            color: white;
            border-color: #f59e0b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Image Modal (Lightbox) -->
    <div id="imageModal" class="fixed inset-0 z-[9999] bg-black/90 hidden flex items-center justify-center p-4 cursor-zoom-out opacity-0 transition-opacity duration-300" onclick="closeModal()">
        <div class="relative inline-block max-w-full max-h-full" onclick="event.stopPropagation()">
            <img id="modalImage" src="" class="max-h-[85vh] max-w-[95vw] rounded-lg shadow-2xl object-contain transform scale-95 transition-transform duration-300">
            <button class="absolute top-4 right-4 text-white p-2 bg-black/50 rounded-full hover:bg-white/20" onclick="closeModal()">
                <i data-lucide="x" class="w-8 h-8 stroke-[3px]"></i>
            </button>
        </div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div id="exitModal" class="fixed inset-0 z-[10000] bg-black/80 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xs transform scale-95 transition-transform duration-300 flex flex-col items-center text-center" onclick="event.stopPropagation()">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-4">
                <i data-lucide="log-out" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ</h3>
            <p class="text-sm text-slate-500 mb-6">æ‚¨å³å°‡é€€å‡ºè¡Œç¨‹åœ°åœ–ã€‚</p>
            <div class="flex gap-3 w-full">
                <button onclick="cancelExit()" class="flex-1 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200 transition-colors">å–æ¶ˆ</button>
                <button onclick="confirmExit()" class="flex-1 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">ç¢ºèªé›¢é–‹</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-3 shadow-md flex items-center justify-between z-30 shrink-0 pt-safe-top">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-amber-500 rounded-lg shadow-lg">
                <i data-lucide="plane" class="text-white w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-base font-bold leading-tight">VIP å³´æ¸¯é«˜çˆ¾å¤«å¥¢è¯ä¹‹æ—…</h1>
                <p class="text-[10px] text-slate-400">2026/04/11 - 04/15</p>
            </div>
        </div>
    </header>

    <!-- Main -->
    <div class="flex flex-1 relative overflow-hidden desktop-flex">
        
        <!-- List View -->
        <aside id="listView" class="w-full lg:w-[420px] flex flex-col bg-white h-full border-r border-gray-200 mobile-view-active z-20 transition-all">
            
            <!-- Stacked Navigation Layout -->
            <div class="shrink-0 bg-slate-50 border-b border-gray-200 z-30 shadow-sm">
                <!-- Map Overview Button (Full Width) -->
                <div class="px-3 pt-3 pb-2">
                     <button onclick="switchDay('all')" id="tab-all" class="w-full tab-btn py-2.5 rounded-lg text-sm font-bold transition-all border bg-white text-slate-600 border-slate-300 hover:bg-slate-100 flex items-center justify-center gap-2 shadow-sm">
                        <i data-lucide="map" class="w-4 h-4"></i> ğŸ“ åœ°åœ–ç¸½è¦½ (å…¨è¡Œç¨‹)
                     </button>
                </div>
                
                <!-- Day Tabs (Flex Row) -->
                <div class="flex px-3 pb-3 gap-2" id="dayTabs">
                    <!-- JS will inject buttons here -->
                </div>
            </div>

            <!-- Itinerary Content with Touch Logic -->
            <div id="itineraryContent" class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-white pb-20 lg:pb-4" style="touch-action: pan-y pinch-zoom;"></div>
        </aside>

        <!-- Map View -->
        <main id="mapView" class="w-full h-full bg-slate-200 relative mobile-view-hidden lg:block flex-1 z-10 transition-all">
            <div id="map" class="w-full h-full z-0"></div>
            
            <!-- Legend Button -->
            <div class="absolute top-4 right-4 z-[500] flex flex-col items-end">
                <button id="legendToggle" class="bg-white p-2.5 rounded-lg shadow-lg border border-gray-200 text-slate-600 mb-2 hover:bg-gray-50">
                    <i data-lucide="info" class="w-5 h-5"></i>
                </button>
                <div id="legendContent" class="hidden bg-white/95 backdrop-blur-sm p-4 rounded-lg shadow-xl border border-gray-200 text-xs w-44 animate-fade-in">
                    <div class="font-bold text-slate-700 mb-2 border-b pb-2">åœ–ä¾‹èªªæ˜</div>
                    <div class="space-y-2.5">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-700"></span> é«˜çˆ¾å¤«çƒå ´</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-indigo-700"></span> å¥¢è¯ä½å®¿</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-700"></span> ç²¾ç·»é¤é£²</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-pink-700"></span> è§€å…‰æ™¯é»</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-700"></span> æ©Ÿå ´/äº¤é€š</div>
                        <div class="flex items-center gap-2 mt-1 text-[10px] text-slate-500 pt-1 border-t"><span class="border border-amber-500 text-amber-600 px-1 rounded">25åˆ†</span> é ä¼°è»Šç¨‹</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Nav -->
    <nav id="bottomNav" class="lg:hidden bg-white border-t border-gray-200 flex justify-around items-center h-16 shrink-0 z-40 fixed bottom-0 w-full shadow-[0_-4px_10px_rgba(0,0,0,0.05)] pb-safe-bottom">
        <button id="navBtnList" class="flex flex-col items-center justify-center w-1/2 h-full text-amber-600 transition-colors" onclick="setMobileView('list')">
            <i data-lucide="list" class="w-5 h-5 mb-1"></i>
            <span class="text-xs font-bold mt-1">è¡Œç¨‹åˆ—è¡¨</span>
        </button>
        <button id="navBtnMap" class="flex flex-col items-center justify-center w-1/2 h-full text-slate-400 hover:text-slate-600 transition-colors" onclick="setMobileView('map')">
            <i data-lucide="map" class="w-5 h-5 mb-1"></i>
            <span class="text-xs font-bold mt-1">åœ°åœ–æ¨¡å¼</span>
        </button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- DATA ---
        const LOCATIONS = {
            taoyuanAirport: {
                lat: 25.077467, lng: 121.231975, name: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)", type: "transport",
                image: "https://www.archi.net.tw/customerpic/10956/prj/prj_10956_202092611212153_2l2.jpg", 
                website: "https://www.taoyuan-airport.com/"
            },
            taoyuanAirportT2: {
                lat: 25.077200, lng: 121.233500, name: "æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ", type: "transport",
                image: "https://www.archi.net.tw/customerpic/10956/prj/prj_10956_202092611212153_2l2.jpg", // T2 Image
                website: "https://www.taoyuan-airport.com/"
            },
            airport: { 
                lat: 16.054452, lng: 108.202166, name: "å³´æ¸¯åœ‹éš›æ©Ÿå ´ (DAD)", type: "transport",
                image: "https://gandan.me/wp-content/uploads/2017/04/20241006-1d18l.jpg", 
                website: "https://danangairportterminal.vn/"
            },
            intercontinental: { 
                lat: 16.120500, lng: 108.306160, name: "InterContinental Resort", type: "hotel",
                image: "https://live.staticflickr.com/65535/54842483435_9297b91884_o.jpg", 
                website: "https://www.danang.intercontinental.com/zh-hant/"
            },
            madameLan: { 
                lat: 16.081581, lng: 108.223346, name: "è—å¤«äººè¶Šå¼é¤å»³", type: "food",
                image: "https://farm66.static.flickr.com/65535/53736162838_50dc1dd787_c.jpg", 
                website: "https://madamelan.vn/en"
            },
            laMaison: { 
                lat: 16.120800, lng: 108.306500, name: "La Maison 1888", type: "food",
                image: "https://www.veganfoodquest.com/wp-content/uploads/2015/11/InterCon-Danang-%C3%A2%E2%82%AC%E2%80%9C-La-Maison-18881.jpg", 
                website: "https://www.danang.intercontinental.com/zh-hant/dining/la-maison-1888/"
            },
            banaHillsGolf: { 
                lat: 16.017641, lng: 108.049361, name: "Ba Na Hills Golf Club", type: "golf",
                image: "https://www.theworldluxurytravelawards.com/wp-content/uploads/sites/13/2023/08/New-Main-scaled.jpg",
                website: "https://banahillsgolf.com/hole-by-hole/"
            },
            myHanh: { 
                lat: 16.065330, lng: 108.246292, name: "MY HANH æµ·é®®", type: "food",
                image: "https://cdn2.ettoday.net/images/8432/d8432457.jpg",
                website: "https://myhanhseafood.vn/#"
            },
            brgGolf: { 
                lat: 15.974087, lng: 108.277424, name: "BRG Da Nang Golf Resort", type: "golf",
                image: "https://image.kkday.com/v2/image/get/w_960,c_fit,q_55,wm_auto/s1.kkday.com/product_131376/20220719142609_NIUUg/jpg", 
                website: "https://brgdananggolf.com/"
            },
            hoiAn: { 
                lat: 15.877108, lng: 108.325970, name: "æœƒå®‰å¤åŸ (æ—¥æœ¬æ©‹)", type: "sight",
                image: "https://i0.wp.com/jazko.com/wp-content/uploads/2018/04/japanese-bridge-in-hoi-an-vietnam-1600x1600-1280x1280.jpg?resize=696%2C696&ssl=1",
                website: "https://www.danang.com.tw/info/guideline/50"
            },
            limDining: { 
                lat: 15.876650, lng: 108.328015, name: "LIM DINING", type: "food",
                image: "https://lh3.googleusercontent.com/places/AKR5kUiw0WHM4aQHwebe4FrT0FxcUFQLhzhxX6SCQ0SfRGbw_IiTtU82BXkOzEBTGfjkCYd4b8OcxXf4APAedHClskTIhER0vP4zTMM=s1600-w640",
                website: "https://www.limdiningroom.com/about"
            },
            newWorld: { 
                lat: 15.826000, lng: 108.393000, name: "New World Hoiana", type: "hotel",
                image: "https://du-lich.chudu24.com/f/m/2305/23/new-world-hoiana-beach-resort.jpg?w=800&h=500",
                website: "https://www.hoiana.com/zh-hant/hotels/new-world-hoiana-beach-resort/"
            },
            hoianaGolf: { 
                lat: 15.824440, lng: 108.405694, name: "Hoiana Shores Golf", type: "golf",
                image: "https://www.ziontourvn.com/uploads/images/image-20250827102239-1.jpeg",
                website: "https://www.hoiana.com/zh-hant/golf/home",
                yardageBook: "https://cdn.prod.website-files.com/68878f00b8a3232197d325a4/68df4ca6f893ec06eebbea9a_Hoiana%20Shores%20Golf%20Club%20-%20Yardage%20book.pdf"
            },
            sanXiLou: { 
                lat: 15.826200, lng: 108.393200, name: "ä¸‰å¸Œæ¨“", type: "food",
                image: "https://starworldtour.com/wp-content/uploads/2024/07/SanXiLou-4-1.jpg", 
                website: "https://www.hoiana.com/zh-hant/dining/san-xi-lou"
            },
        };

        const ITINERARY = [
            {
                day: 1,
                date: "04/11",
                weather: "â›… 24Â°C-30Â°C æ™´æ™‚å¤šé›²",
                title: "å‡ºç™¼ & å¥¢è¯å…¥ä½",
                desc: "å¾å°åŒ—é£›å¾€å³´æ¸¯ï¼Œäº«ç”¨è¶Šå¼åˆé¤å¾Œå…¥ä½é ‚ç´šæ´²éš›é…’åº—ã€‚",
                route: [
                    { ...LOCATIONS.taoyuanAirport, time: "09:45", note: "é•·æ¦® BR383 é£›å¾€å³´æ¸¯" },
                    { ...LOCATIONS.airport, time: "11:35", note: "æŠµé”å³´æ¸¯ (é£›è¡Œç´„ 2å°æ™‚50åˆ†)" },
                    { ...LOCATIONS.madameLan, time: "12:30", note: "åˆé¤: è—å¤«äººè¶Šå¼é¤å»³" },
                    { ...LOCATIONS.intercontinental, time: "15:00", note: "Check-in & è¨­æ–½é«”é©—" },
                    { ...LOCATIONS.laMaison, time: "18:00", note: "æ™šé¤: La Maison 1888 (ç±³å…¶æ—ä¸€æ˜Ÿ)" }
                ],
                stay: LOCATIONS.intercontinental
            },
            {
                day: 2,
                date: "04/12",
                weather: "â˜€ï¸ 25Â°C-31Â°C æ™´æœ—ç‚ç†±",
                title: "å·´æ‹¿å±±é«˜çˆ¾å¤«æŒ‘æˆ°",
                desc: "å‰å¾€ Ba Na Hills çƒå ´æ®æ¡¿ï¼Œæ™šä¸Šäº«ç”¨æµ·é®®å¤§é¤ã€‚",
                route: [
                    { ...LOCATIONS.intercontinental, time: "09:30", note: "é£¯åº—å‡ºç™¼ (å‰å¾€çƒå ´)" },
                    { ...LOCATIONS.banaHillsGolf, time: "11:00", note: "Ba Na Hills Golf 18 Holes" },
                    { ...LOCATIONS.myHanh, time: "18:00", note: "æ™šé¤: MY HANH SEAFOOD" },
                    { ...LOCATIONS.intercontinental, time: "21:00", note: "è¿”å›é£¯åº—ä¼‘æ¯" }
                ],
                stay: LOCATIONS.intercontinental
            },
            {
                day: 3,
                date: "04/13",
                weather: "ğŸŒ¥ï¸ 24Â°C-29Â°C å¤šé›²",
                title: "BRG é«˜çƒ & æœƒå®‰å¤åŸ",
                desc: "ä¸Šåˆ BRG çƒæ•˜ï¼Œä¸‹åˆæ¢ç´¢ä¸–ç•Œæ–‡åŒ–éºç”¢æœƒå®‰å¤åŸã€‚",
                route: [
                    { ...LOCATIONS.intercontinental, time: "10:00", note: "é€€æˆ¿å‡ºç™¼" },
                    { ...LOCATIONS.brgGolf, time: "11:00", note: "BRG Da Nang Golf Resort" },
                    { ...LOCATIONS.hoiAn, time: "16:00", note: "æœƒå®‰å¤åŸ (æ—¥æœ¬æ©‹)" },
                    { ...LOCATIONS.limDining, time: "18:00", note: "æ™šé¤: LIM DINING" },
                    { ...LOCATIONS.newWorld, time: "20:30", note: "Check-in: New World Hoiana" }
                ],
                stay: LOCATIONS.newWorld
            },
            {
                day: 4,
                date: "04/14",
                weather: "ğŸŒ¤ï¸ 25Â°C-30Â°C æ™´æ™‚å¤šé›²",
                title: "Hoiana æµ·å²¸é«˜çˆ¾å¤«",
                desc: "åœ¨äºæ´²ç™¾å¤§çƒå ´ Hoiana Shores äº«å—æ®æ¡¿æ¨‚è¶£ã€‚",
                route: [
                    { ...LOCATIONS.newWorld, time: "10:00", note: "é£¯åº—å‡ºç™¼ (å‰å¾€çƒå ´)" },
                    { ...LOCATIONS.hoianaGolf, time: "11:00", note: "Hoiana Shores Golf" },
                    { ...LOCATIONS.sanXiLou, time: "18:00", note: "æ™šé¤: ä¸‰å¸Œæ¨“ç²µå¼é¤å»³" }
                ],
                stay: LOCATIONS.newWorld
            },
            {
                day: 5,
                date: "04/15",
                weather: "â˜€ï¸ 25Â°C-31Â°C æ™´æœ—",
                title: "è¿”ç¨‹",
                desc: "æ‚ é–’æ—©é¤ï¼Œç™»æ©Ÿå‰4å°æ™‚é€€æˆ¿ï¼Œè¿”å›å°åŒ—ã€‚",
                route: [
                    { ...LOCATIONS.newWorld, time: "08:35", note: "é€€æˆ¿ & å‡ºç™¼ (BR384)" },
                    { ...LOCATIONS.airport, time: "09:35", note: "æŠµé”æ©Ÿå ´ (12:35 èµ·é£›)" },
                    { ...LOCATIONS.taoyuanAirportT2, time: "16:45", note: "æŠµé”æ¡ƒåœ’æ©Ÿå ´2èˆªå»ˆ (é£›è¡Œç´„ 3å°æ™‚10åˆ†)" }
                ],
                stay: null
            }
        ];

        // --- APP LOGIC ---
        let map, markersLayer, polylineLayer, labelsLayer, selectedDayId = 1, currentBounds = [];
        const routePalette = ['#e11d48', '#d97706', '#059669', '#2563eb', '#7c3aed'];
        let isExiting = false;
        // RENDER ID FOR ASYNC MAP UPDATES
        let currentRenderId = 0;

        // --- CUSTOM ROUTING TIME TABLE (Google Maps Estimates) ---
        const routeTimes = {
            "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)-å³´æ¸¯åœ‹éš›æ©Ÿå ´ (DAD)": "2å°æ™‚50åˆ†",
            "å³´æ¸¯åœ‹éš›æ©Ÿå ´ (DAD)-è—å¤«äººè¶Šå¼é¤å»³": "15 åˆ†é˜",
            "è—å¤«äººè¶Šå¼é¤å»³-InterContinental Resort": "35 åˆ†é˜",
            "InterContinental Resort-La Maison 1888": "æ­¥è¡Œ",
            "InterContinental Resort-Ba Na Hills Golf Club": "70 åˆ†é˜",
            "Ba Na Hills Golf Club-MY HANH æµ·é®®": "45 åˆ†é˜",
            "MY HANH æµ·é®®-InterContinental Resort": "25 åˆ†é˜",
            "InterContinental Resort-BRG Da Nang Golf Resort": "35 åˆ†é˜",
            "BRG Da Nang Golf Resort-æœƒå®‰å¤åŸ (æ—¥æœ¬æ©‹)": "20 åˆ†é˜",
            "æœƒå®‰å¤åŸ (æ—¥æœ¬æ©‹)-LIM DINING": "æ­¥è¡Œ",
            "LIM DINING-New World Hoiana": "15 åˆ†é˜",
            "New World Hoiana-Hoiana Shores Golf": "5 åˆ†é˜",
            "Hoiana Shores Golf-ä¸‰å¸Œæ¨“": "æ­¥è¡Œ",
            "New World Hoiana-å³´æ¸¯åœ‹éš›æ©Ÿå ´ (DAD)": "55 åˆ†é˜",
            "å³´æ¸¯åœ‹éš›æ©Ÿå ´ (DAD)-æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ": "3å°æ™‚10åˆ†"
        };

        // --- ICONS ---
        const getIconHtml = (type) => {
            const icons = { golf: 'flag', hotel: 'bed', food: 'utensils', sight: 'camera', transport: 'plane' };
            const svgs = {
                flag: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>',
                bed: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></svg>',
                utensils: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>',
                camera: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>',
                plane: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h20"/><path d="M13 2l-8 7h12l5 3"/></svg>'
            };
            return svgs[icons[type] || 'map-pin'];
        };

        const createCustomIcon = (type) => {
            const colorClass = `bg-${type}`;
            const svg = getIconHtml(type);
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin ${colorClass}"><div class="marker-icon-svg">${svg}</div></div>`,
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -38]
            });
        };

        // --- MAP FUNCTIONS ---
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }
        
        function getBearing(startLat, startLng, destLat, destLng) {
            const startLatRad = deg2rad(startLat);
            const startLngRad = deg2rad(startLng);
            const destLatRad = deg2rad(destLat);
            const destLngRad = deg2rad(destLng);

            const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
            const x = Math.cos(startLatRad) * Math.sin(destLatRad) -
                    Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);
            const brng = Math.atan2(y, x);
            return (brng * 180 / Math.PI + 360) % 360;
        }

        function getRouteTime(startName, endName) {
            const key = `${startName}-${endName}`;
            if (routeTimes[key]) return routeTimes[key];
            if ((startName.includes("InterContinental") && endName.includes("La Maison")) ||
                (endName.includes("InterContinental") && startName.includes("La Maison"))) return "æ­¥è¡Œ";
            if ((startName.includes("New World") && endName.includes("ä¸‰å¸Œæ¨“")) ||
                (endName.includes("New World") && startName.includes("ä¸‰å¸Œæ¨“"))) return "æ­¥è¡Œ";
            return "è»Šç¨‹ç´„ 20 åˆ†"; 
        }

        async function fetchRouteGeometry(p1, p2) {
            const url = `https://router.project-osrm.org/route/v1/driving/${p1[1]},${p1[0]};${p2[1]},${p2[0]}?overview=full&geometries=geojson`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    return data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                }
            } catch (error) {
                console.log("OSRM fetch failed, using straight line", error);
            }
            return [p1, p2];
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([16.0544, 108.2022], 10);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap', maxZoom: 19
            }).addTo(map);
            
            markersLayer = L.layerGroup().addTo(map);
            polylineLayer = L.layerGroup().addTo(map);
            labelsLayer = L.layerGroup().addTo(map);

            renderDayTabs();
            renderItinerary(1);
        }

        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = ITINERARY.map(item => `
                <button onclick="switchDay(${item.day})" id="tab-${item.day}"
                    class="tab-btn flex-1 py-2 rounded-lg text-xs font-bold transition-all border shrink-0 ${item.day === selectedDayId ? 'bg-amber-500 text-white border-amber-500 shadow-md' : 'bg-white text-slate-500 border-gray-300'}"
                >DAY ${item.day}</button>
            `).join('');
        }

        function switchDay(day) {
            selectedDayId = day;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.id.startsWith('tab-') && btn.id !== 'tab-all') {
                    btn.className = "tab-btn flex-1 py-2 rounded-lg text-xs font-bold transition-all border shrink-0 bg-white text-slate-500 border-gray-300";
                }
            });
            
            const btnOverview = document.getElementById('tab-all');
            if(btnOverview) {
                if (day === 'all') {
                    btnOverview.className = "w-full tab-btn py-2.5 rounded-lg text-sm font-bold transition-all border bg-amber-500 text-white border-amber-500 hover:bg-amber-600 flex items-center justify-center gap-2 shadow-md";
                } else {
                    btnOverview.className = "w-full tab-btn py-2.5 rounded-lg text-sm font-bold transition-all border bg-white text-slate-600 border-slate-300 hover:bg-slate-100 flex items-center justify-center gap-2 shadow-sm";
                    const activeBtn = document.getElementById(`tab-${day}`);
                    if(activeBtn) activeBtn.className = "tab-btn flex-1 py-2 rounded-lg text-xs font-bold transition-all border shrink-0 bg-amber-500 text-white border-amber-500 shadow-md";
                }
            }
            
            // Scroll to top of itinerary content when switching
            const contentDiv = document.getElementById('itineraryContent');
            if (contentDiv) contentDiv.scrollTop = 0;

            if (day === 'all') {
                renderAllLocations();
                updateMap('all');
            } else {
                renderItinerary(day);
                updateMap(ITINERARY.find(d => d.day === day));
            }
        }

        function renderAllLocations() {
             document.getElementById('itineraryContent').innerHTML = `
                <div class="mb-4 animate-fade-in">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">ğŸ‡»ğŸ‡³ è¶Šå—è¡Œç¨‹åœ°åœ–ç¸½è¦½</h2>
                    <p class="text-xs text-slate-600 bg-amber-50 p-3 rounded-lg border-l-4 border-amber-400">
                        æ­¤æ¨¡å¼é¡¯ç¤ºæœ¬æ¬¡æ—…ç¨‹åœ¨è¶Šå—å¢ƒå…§çš„æ‰€æœ‰æ™¯é»ã€é¤å»³èˆ‡çƒå ´åˆ†ä½ˆã€‚é»æ“Šåœ°åœ–åœ–æ¨™å¯æŸ¥çœ‹è©³æƒ…ã€‚
                    </p>
                </div>
                <div class="grid grid-cols-1 gap-3 pb-20 animate-fade-in">
                    ${Object.values(LOCATIONS).filter(loc => loc.lat < 20).map(loc => `
                        <div class="flex items-center gap-3 p-3 bg-white rounded-lg border border-slate-100 shadow-sm cursor-pointer hover:bg-slate-50 transition-colors" onclick="zoomToLocation(${loc.lat}, ${loc.lng})">
                             <div class="relative z-10 w-10 h-10 rounded-full border-2 border-white shadow-sm flex items-center justify-center shrink-0 bg-${loc.type === 'hotel' ? 'hotel' : loc.type === 'golf' ? 'golf' : loc.type === 'food' ? 'food' : loc.type === 'sight' ? 'sight' : 'transport'} text-white">
                                    ${getIconHtml(loc.type)}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-slate-800 text-sm truncate">${loc.name}</h4>
                                <div class="flex gap-2 mt-1">
                                    <button class="text-[12px] text-white bg-blue-600 px-2 py-1 rounded-full shadow-sm" onclick="event.stopPropagation(); window.open('https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}')">å°èˆª</button>
                                    ${loc.website ? `<button class="text-[12px] text-white bg-emerald-600 px-2 py-1 rounded-full shadow-sm" onclick="event.stopPropagation(); window.open('${loc.website}')">å®˜ç¶²</button>` : ''}
                                </div>
                            </div>
                            <img src="${loc.image}" class="w-12 h-12 rounded object-cover bg-gray-200 shadow-sm" onclick="openModal(this.src); event.stopPropagation();">
                        </div>
                    `).join('')}
                </div>
             `;
        }

        window.openModal = function(src) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            img.src = src;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                img.classList.remove('scale-95');
                img.classList.add('scale-100');
            }, 10);
        }

        window.closeModal = function() {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            modal.classList.add('opacity-0');
            img.classList.remove('scale-100');
            img.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function renderItinerary(day) {
            const data = ITINERARY.find(d => d.day === day);
            document.getElementById('itineraryContent').innerHTML = `
                <div class="mb-4 animate-fade-in">
                    <div class="flex items-center flex-wrap gap-2 mb-1">
                        <span class="px-2 py-0.5 bg-amber-100 text-amber-700 text-[10px] font-bold rounded">DAY ${data.day}</span>
                        <span class="text-slate-400 text-xs font-medium">${data.date}</span>
                        <span class="text-blue-600 text-xs font-bold border border-blue-200 bg-blue-50 px-2 py-0.5 rounded-full">${data.weather}</span>
                        <p class="text-xs text-slate-400 mt-2 text-center lg:hidden w-full">â†” å·¦å³æ»‘å‹•åˆ‡æ›å¤©æ•¸</p>
                    </div>
                    <h2 class="text-lg font-bold text-slate-800 mb-1 leading-tight">${data.title}</h2>
                    <p class="text-xs text-slate-600 italic border-l-2 border-amber-400 pl-2 bg-amber-50 py-1.5 rounded-r">${data.desc}</p>
                </div>
                <div class="relative space-y-4 pl-1 animate-fade-in">
                    <div class="absolute left-[20px] top-2 bottom-4 w-[2px] bg-slate-200"></div>
                    ${data.route.map((stop, idx) => {
                        let connectorHtml = '';
                        if (idx < data.route.length - 1) {
                            const nextStop = data.route[idx+1];
                            const displayTime = getRouteTime(stop.name, nextStop.name);
                            connectorHtml = `
                                <div class="flex flex-col items-center flex-1 w-full my-1">
                                    <div class="w-0.5 h-2 bg-slate-200 shrink-0"></div>
                                    <span class="bg-white border-2 border-red-500 text-sm text-red-600 font-bold px-2 rounded-full z-10 leading-none py-1 whitespace-nowrap">
                                        ${displayTime}
                                    </span>
                                    <div class="w-0.5 h-full bg-slate-200"></div>
                                </div>
                            `;
                        }

                        return `
                        <div class="relative flex gap-3 group cursor-pointer active:bg-gray-100 p-2 rounded-lg transition-colors border border-transparent hover:border-gray-200" onclick="zoomToLocation(${stop.lat}, ${stop.lng})">
                            
                            <div class="flex flex-col items-end pt-1 w-12 shrink-0">
                                <span class="text-sm font-bold text-slate-700 font-mono leading-none">${stop.time}</span>
                            </div>

                            <div class="flex flex-col items-center gap-1 w-8 shrink-0">
                                <div class="relative z-10 w-8 h-8 rounded-full border-2 border-white shadow-sm flex items-center justify-center shrink-0 bg-${stop.type} text-white">
                                    ${getIconHtml(stop.type)}
                                </div>
                                ${connectorHtml}
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center gap-2 mb-0.5">
                                            ${stop.note.includes("ç­æ©Ÿ") || stop.note.includes("é€€æˆ¿") ? `<span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-red-100 text-red-600 flex items-center gap-1">âš ï¸ é‡è¦</span>` : ''}
                                        </div>
                                        <h3 class="font-bold text-slate-800 text-sm leading-tight mb-1">${stop.name}</h3>
                                    </div>
                                    <img src="${stop.image}" class="w-16 h-12 object-cover rounded-md shadow-sm border border-gray-100 shrink-0 ml-2 bg-gray-100 zoomable-image" loading="lazy" alt="${stop.name}" onerror="this.src='https://via.placeholder.com/150'" onclick="openModal(this.src); event.stopPropagation();">
                                </div>
                                <p class="text-[11px] text-slate-500 mt-0.5 line-clamp-2">${stop.note}</p>
                                <div class="flex gap-2 mt-2">
                                    <button class="inline-flex items-center text-sm text-white bg-blue-600 px-3 py-1.5 rounded-full shadow-sm active:scale-95 transition-transform" onclick="event.stopPropagation(); window.open('https://www.google.com/maps/search/?api=1&query=${stop.lat},${stop.lng}')">
                                        <i data-lucide="navigation" class="w-3.5 h-3.5 mr-1"></i> å°èˆª
                                    </button>
                                    ${stop.website ? `<button class="inline-flex items-center text-sm text-white bg-emerald-600 px-3 py-1.5 rounded-full shadow-sm active:scale-95 transition-transform" onclick="event.stopPropagation(); window.open('${stop.website}')"><i data-lucide="globe" class="w-3.5 h-3.5 mr-1"></i> å®˜ç¶²</button>` : ''}
                                    ${stop.yardageBook ? `<button class="inline-flex items-center text-sm text-white bg-orange-600 px-3 py-1.5 rounded-full shadow-sm active:scale-95 transition-transform" onclick="event.stopPropagation(); window.open('${stop.yardageBook}')"><i data-lucide="book-open" class="w-3.5 h-3.5 mr-1"></i> ç¢¼æ•¸æœ¬</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('')}
                    ${data.stay ? `
                    <div class="mt-4 pt-4 border-t border-gray-100 ml-14">
                        <div class="bg-slate-800 text-white p-3 rounded-xl flex items-center gap-3 shadow-lg">
                            <div class="p-1.5 bg-white/10 rounded-full"><i data-lucide="bed" class="w-4 h-4"></i></div>
                            <div>
                                <div class="text-[9px] text-slate-400 uppercase tracking-widest mb-0.5">æœ¬æ—¥ä½å®¿</div>
                                <div class="font-bold text-xs">${data.stay.name}</div>
                            </div>
                        </div>
                    </div>` : ''}
                </div>`;
            lucide.createIcons();
            
            attachSwipeListeners();
            updateMap(data);
        }

        async function updateMap(dayData) {
            // Async guard check: increment render ID
            const renderId = ++currentRenderId;
            
            markersLayer.clearLayers(); polylineLayer.clearLayers(); labelsLayer.clearLayers();
            const latLngs = [];
            const fitBoundsLatLngs = []; 

            if (dayData === 'all') {
                // Overview Mode
                Object.values(LOCATIONS).forEach(loc => {
                    if (loc.lat < 20) { // Filter out Taiwan
                        L.marker([loc.lat, loc.lng], { icon: createCustomIcon(loc.type) })
                            .bindPopup(`
                                <div class="font-sans w-[240px]">
                                    <img src="${loc.image}" class="w-full h-32 object-cover rounded-t-lg mb-2 zoomable-image" alt="${loc.name}" onerror="this.src='https://via.placeholder.com/150'" onclick="openModal(this.src)">
                                    <div class="px-2 pb-2">
                                        <h3 class="font-bold text-sm mb-2 text-slate-800">${loc.name}</h3>
                                        <div class="flex gap-2">
                                            <a href="https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}" target="_blank" class="flex-1 text-center bg-blue-600 text-white text-sm font-bold py-2 rounded shadow hover:bg-blue-700 transition-colors">å°èˆª</a>
                                            ${loc.website ? `<a href="${loc.website}" target="_blank" class="flex-1 text-center bg-emerald-600 text-white text-sm font-bold py-2 rounded shadow hover:bg-emerald-700 transition-colors">å®˜ç¶²</a>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).bindTooltip(loc.name, { 
                                permanent: true, 
                                direction: 'top', 
                                offset: [0, -40], 
                                className: 'custom-tooltip' 
                            })
                            .addTo(markersLayer);
                        fitBoundsLatLngs.push([loc.lat, loc.lng]);
                    }
                });
                currentBounds = fitBoundsLatLngs;
            } else {
                // Single Day Mode
                dayData.route.forEach(stop => {
                    const latLng = [stop.lat, stop.lng];
                    latLngs.push(latLng);
                    if (stop.lat < 20) fitBoundsLatLngs.push(latLng);

                    const tooltipDir = stop.type === 'hotel' ? 'top' : 'bottom';
                    const tooltipOff = stop.type === 'hotel' ? [0, -40] : [0, 5];

                    const isDay1AndNewWorld = dayData.day === 1 && stop.name.includes("New World"); 
                    const isDay2AndNewWorld = dayData.day === 2 && stop.name === LOCATIONS.newWorld.name; 
                    const isDay4AndInterCon = dayData.day === 4 && stop.name === LOCATIONS.intercontinental.name; 

                    L.marker(latLng, { icon: createCustomIcon(stop.type) })
                        .bindPopup(`
                            <div class="font-sans w-[240px]">
                                <img src="${stop.image}" class="w-full h-32 object-cover rounded-t-lg mb-2 zoomable-image" alt="${stop.name}" onerror="this.src='https://via.placeholder.com/150'" onclick="openModal(this.src)">
                                <div class="px-2 pb-2">
                                    <div class="text-[10px] font-bold text-slate-500 mb-1">${stop.time}</div>
                                    <h3 class="font-bold text-sm mb-2 text-slate-800">${stop.name}</h3>
                                    <div class="flex gap-2 flex-wrap">
                                        <a href="https://www.google.com/maps/search/?api=1&query=${stop.lat},${stop.lng}" target="_blank" class="flex-1 text-center bg-blue-600 text-white text-sm font-bold py-2 rounded shadow hover:bg-blue-700 transition-colors">å°èˆª</a>
                                        ${stop.website ? `<a href="${stop.website}" target="_blank" class="flex-1 text-center bg-emerald-600 text-white text-sm font-bold py-2 rounded shadow hover:bg-emerald-700 transition-colors">å®˜ç¶²</a>` : ''}
                                        ${stop.yardageBook ? `<a href="${stop.yardageBook}" target="_blank" class="flex-1 text-center bg-orange-600 text-white text-sm font-bold py-2 rounded shadow hover:bg-orange-700 transition-colors">ç¢¼æ•¸æœ¬</a>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).bindTooltip(stop.name, { 
                            permanent: true, 
                            direction: tooltipDir, 
                            offset: tooltipOff, 
                            className: 'custom-tooltip' 
                        })
                        .addTo(markersLayer);
                });

                for (let i = 0; i < latLngs.length - 1; i++) {
                    const p1 = latLngs[i];
                    const p2 = latLngs[i+1];
                    const color = routePalette[i % routePalette.length];
                    const stop1 = dayData.route[i];
                    const stop2 = dayData.route[i+1];
                    const displayTime = getRouteTime(stop1.name, stop2.name);
                    const isFlight = displayTime.includes('é£›è¡Œ') || displayTime.includes('å°æ™‚');
                    
                    let routePoints = [p1, p2];
                    if (!isFlight) {
                        routePoints = await fetchRouteGeometry(p1, p2);
                        // Guard against stale async renders
                        if (renderId !== currentRenderId) return;
                    }

                    L.polyline(routePoints, { 
                        color: color, 
                        weight: 4, 
                        opacity: 0.8, 
                        dashArray: isFlight ? '8, 12' : null 
                    }).addTo(polylineLayer);

                    const mid = [(p1[0] + p2[0])/2, (p1[1] + p2[1])/2];
                    const bearing = getBearing(p1[0], p1[1], p2[0], p2[1]);
                    
                    const labelIcon = L.divIcon({
                        className: 'time-label-icon',
                        html: `
                            <div class="relative flex items-center justify-center w-24 h-8" style="transform: translate(-50%, -50%);">
                                <div style="position: absolute; transform: translate(-50%, -50%) rotate(${bearing}deg);">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${color}" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="arrow-on-line">
                                        <polygon points="12 2 22 22 12 18 2 22 12 2"></polygon>
                                    </svg>
                                </div>
                                <div class="bg-white/95 border border-${color} text-slate-700 time-badge font-bold rounded-full shadow-sm whitespace-nowrap mt-6" style="border-color: ${color};">
                                    ${displayTime}
                                </div>
                            </div>
                        `,
                        iconSize: [0, 0], 
                        iconAnchor: [0, 0]
                    });
                    L.marker(mid, { icon: labelIcon, zIndexOffset: 1000 }).addTo(labelsLayer);
                }

                [LOCATIONS.intercontinental, LOCATIONS.newWorld].forEach(h => {
                    const inRoute = dayData.route.some(r => r.name === h.name);
                    const isDay1AndNewWorld = dayData.day === 1 && h.name === LOCATIONS.newWorld.name;
                    const isDay2AndNewWorld = dayData.day === 2 && h.name === LOCATIONS.newWorld.name;
                    const isDay4AndInterCon = dayData.day === 4 && h.name === LOCATIONS.intercontinental.name;

                    if (!inRoute && !isDay1AndNewWorld && !isDay2AndNewWorld && !isDay4AndInterCon) {
                        L.marker([h.lat, h.lng], { icon: createCustomIcon('hotel'), opacity: 0.5 })
                            .addTo(markersLayer)
                            .bindTooltip(h.name, { 
                                permanent: true, 
                                direction: 'top', 
                                offset: [0, -40], 
                                className: 'custom-tooltip opacity-75' 
                            });
                        if (h.lat < 20) fitBoundsLatLngs.push([h.lat, h.lng]);
                    }
                });

                currentBounds = fitBoundsLatLngs.length > 0 ? fitBoundsLatLngs : latLngs;
            }

            if(window.innerWidth >= 1024 || document.getElementById('mapView').classList.contains('mobile-view-active')) {
                if(currentBounds.length > 0) map.fitBounds(currentBounds, { padding: [50, 50], maxZoom: 14 });
            }
        }

        function setMobileView(view) {
            const list = document.getElementById('listView');
            const mapDiv = document.getElementById('mapView');
            const btnList = document.getElementById('navBtnList');
            const btnMap = document.getElementById('navBtnMap');

            if (view === 'list') {
                list.className = "w-full lg:w-[420px] flex flex-col bg-white h-full border-r border-gray-200 mobile-view-active z-20";
                mapDiv.className = "w-full h-full bg-slate-200 relative mobile-view-hidden lg:block flex-1 z-10";
                btnList.className = "flex flex-col items-center justify-center w-1/2 h-full text-amber-600 transition-colors";
                btnMap.className = "flex flex-col items-center justify-center w-1/2 h-full text-slate-400 hover:text-slate-600 transition-colors";
            } else {
                list.className = "w-full lg:w-[420px] flex flex-col bg-white h-full border-r border-gray-200 mobile-view-hidden lg:flex z-20";
                mapDiv.className = "w-full h-full bg-slate-200 relative mobile-view-active lg:block flex-1 z-10";
                btnList.className = "flex flex-col items-center justify-center w-1/2 h-full text-slate-400 hover:text-slate-600 transition-colors";
                btnMap.className = "flex flex-col items-center justify-center w-1/2 h-full text-blue-600 transition-colors";
                setTimeout(() => { 
                    map.invalidateSize(); 
                    if(currentBounds.length) map.fitBounds(currentBounds, {padding:[50,50], maxZoom:14}); 
                }, 100);
            }
        }

        function zoomToLocation(lat, lng) {
            if (window.innerWidth < 1024) {
                setMobileView('map');
            }
            setTimeout(() => map.flyTo([lat, lng], 16, { duration: 1.5 }), 150);
        }

        document.getElementById('legendToggle').addEventListener('click', () => {
            document.getElementById('legendContent').classList.toggle('hidden');
        });

        // Exit Logic
        window.addEventListener('load', function() {
            window.history.pushState({ app: true }, "", "");
        });
        window.addEventListener('popstate', function(event) {
            if (isExiting) return; 
            showExitModal();
        });

        function showExitModal() {
            const modal = document.getElementById('exitModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function cancelExit() {
            window.history.pushState({ app: true }, "", "");
            const modal = document.getElementById('exitModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function confirmExit() {
            isExiting = true;
            const modal = document.getElementById('exitModal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            
            try {
                window.history.back(); 
                window.close(); 
            } catch (e) {
                console.log("Exit failed");
            }
        }

        // Touch Swipe Logic
        function attachSwipeListeners() {
            let touchstartX = 0;
            let touchendX = 0;
            let touchstartY = 0;
            let touchendY = 0;

            const contentDiv = document.getElementById('itineraryContent');
            if(!contentDiv) return;

            contentDiv.addEventListener('touchstart', e => {
                touchstartX = e.changedTouches[0].screenX;
                touchstartY = e.changedTouches[0].screenY;
            });

            contentDiv.addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                touchendY = e.changedTouches[0].screenY;
                handleSwipe();
            });

            function handleSwipe() {
                const xDiff = touchendX - touchstartX;
                const yDiff = touchendY - touchstartY;

                // Check if horizontal swipe is dominant and long enough (>50px)
                if (Math.abs(xDiff) > Math.abs(yDiff) && Math.abs(xDiff) > 50) {
                    if (xDiff < 0) {
                        // Swipe Left -> Next Day
                        if (selectedDayId !== 'all' && selectedDayId < 5) switchDay(selectedDayId + 1);
                    } else {
                        // Swipe Right -> Prev Day
                        if (selectedDayId !== 'all') {
                            if(selectedDayId > 1) switchDay(selectedDayId - 1);
                            // Removed 'all' transition
                        }
                    }
                }
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            initMap();
            lucide.createIcons();
            if (window.innerWidth < 1024) setMobileView('list');
            attachSwipeListeners();
        });
    </script>
</body>
</html>